name: Build & deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  FIREBASE_VERSION: 11.18.0
  HUGO_VERSION: 0.108.0

jobs:
  build_deploy:
    name: Build & deploy
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}
      - name: Cache Firebase
        id: cache-firebase
        uses: actions/cache@v3
        with:
          path: ~/bin/firebase/${{ env.FIREBASE_VERSION }}
          key: ${{ runner.os }}-${{ env.FIREBASE_VERSION }}-firebase
      - name: Install Firebase
        if: steps.cache-firebase.outputs.cache-hit == false
        run: |
          curl -sL --create-dirs -o "${HOME}/bin/firebase/${FIREBASE_VERSION}/firebase" "https://github.com/firebase/firebase-tools/releases/download/v${FIREBASE_VERSION}/firebase-tools-linux"
          chmod +x "${HOME}/bin/firebase/${FIREBASE_VERSION}/firebase"
      - name: Setup Firebase
        run: echo "${HOME}/bin/firebase/${FIREBASE_VERSION}" >> $GITHUB_PATH
      - name: Setup Hugo
        run: |
          curl -sL --create-dirs -o "${RUNNER_TEMP}/hugo/${HUGO_VERSION}/hugo.tar.gz" "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.tar.gz"
          mkdir -p "${HOME}/bin/hugo/${HUGO_VERSION}"
          (cd "${HOME}/bin/hugo/${HUGO_VERSION}" && tar -xvf "${RUNNER_TEMP}/hugo/${HUGO_VERSION}/hugo.tar.gz" hugo && chmod +x hugo)
          echo "${HOME}/bin/hugo/${HUGO_VERSION}" >> $GITHUB_PATH
      - name: Build
        run: hugo
      - name: Deploy
        run: firebase deploy --project "${FIREBASE_PROJECT}"
        env:
          FIREBASE_PROJECT: ${{ secrets.FIREBASE_PROJECT }}
